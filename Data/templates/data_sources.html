{% extends "base.html" %}
{% load static %}

{% block title %}Data Sources - DataScope{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/data_sources.css' %}">
{% endblock %}

{% block content %}
<div class="data-sources-container">
    <!-- Header Section -->
    <header class="page-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="page-title">Data Sources</h1>
                <p class="page-subtitle">Select and manage your connected data sources</p>
            </div>
            <div class="header-badge">
                <span class="badge">{{ total_sources }} active source{{ total_sources|pluralize }}</span>
            </div>
        </div>
    </header>

    <!-- Messages -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            <svg class="alert-icon" viewBox="0 0 24 24" fill="none">
                {% if message.tags == 'success' %}
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2"/>
                <polyline points="22 4 12 14.01 9 11.01" stroke="currentColor" stroke-width="2"/>
                {% elif message.tags == 'error' %}
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/>
                <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
                {% else %}
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
                <line x1="12" y1="16" x2="12.01" y2="16" stroke="currentColor" stroke-width="2"/>
                {% endif %}
            </svg>
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Data Source Selector -->
    <div class="selector-card">
        <div class="selector-header">
            <label class="selector-label">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" stroke="currentColor" stroke-width="2"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="22.08" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
                </svg>
                Select Data Source
            </label>
            
            <form method="GET" action="{% url 'data_sources' %}" class="source-form">
                <div class="select-wrapper">
                    <select name="source_id" id="source-select" class="source-select" onchange="updateSourceType(this)">
                        <option value="">Choose a data source...</option>
                        
                        {% if uploaded_files %}
                        <optgroup label="üìÅ Uploaded Files">
                            {% for file in uploaded_files %}
                            <option value="{{ file.id }}" 
                                    data-type="file"
                                    {% if selected_source and selected_type == 'file' and selected_source.id == file.id %}selected{% endif %}>
                                {{ file.name }} ({{ file.uploaded_at|date:"M d, Y" }})
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endif %}
                        
                        {% if db_connections %}
                        <optgroup label="üóÑÔ∏è Database Connections">
                            {% for db in db_connections %}
                            <option value="{{ db.id }}" 
                                    data-type="db"
                                    {% if selected_source and selected_type == 'db' and selected_source.id == db.id %}selected{% endif %}>
                                {{ db.name }} ({{ db.get_engine_display }})
                                {% if db.is_active %}‚≠ê{% endif %}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endif %}
                    </select>
                    
                    <input type="hidden" name="source_type" id="source-type-input" value="{{ selected_type }}">
                    
                    <svg class="select-arrow" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                </div>
                
                <button type="submit" class="btn-primary">
                    <svg class="icon" viewBox="0 0 24 24" fill="none">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    View Source
                </button>
            </form>
        </div>
        
        <!-- Selected Source Information -->
        {% if selected_source and source_info %}
        <div class="source-info">
            <div class="info-header">
                <h3>Selected Source Details</h3>
                <span class="status-badge status-{{ source_info.status|lower }}">
                    {{ source_info.status }}
                </span>
            </div>
            
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Name</span>
                    <span class="info-value">{{ source_info.name }}</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">Type</span>
                    <span class="info-value">{{ source_info.type }}</span>
                </div>
                
                {% if source_info.row_count %}
                <div class="info-item">
                    <span class="info-label">Rows</span>
                    <span class="info-value">{{ source_info.row_count|floatformat:0 }}</span>
                </div>
                {% endif %}
                
                {% if source_info.column_count %}
                <div class="info-item">
                    <span class="info-label">Columns</span>
                    <span class="info-value">{{ source_info.column_count }}</span>
                </div>
                {% endif %}
                
                {% if source_info.table_count %}
                <div class="info-item">
                    <span class="info-label">Tables</span>
                    <span class="info-value">{{ source_info.table_count }}</span>
                </div>
                {% endif %}
                
                {% if source_info.host %}
                <div class="info-item">
                    <span class="info-label">Host</span>
                    <span class="info-value">{{ source_info.host }}</span>
                </div>
                {% endif %}
                
                <div class="info-item">
                    <span class="info-label">Created</span>
                    <span class="info-value">
                        {% if source_info.uploaded_at %}
                            {{ source_info.uploaded_at|date:"M d, Y H:i" }}
                        {% elif source_info.created_at %}
                            {{ source_info.created_at|date:"M d, Y H:i" }}
                        {% endif %}
                    </span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <form method="POST" action="{% url 'set_active_source' %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="source_id" value="{{ selected_source.id }}">
                    <input type="hidden" name="source_type" value="{{ selected_type }}">
                    <button type="submit" class="btn-action btn-analyze">
                        <svg class="icon" viewBox="0 0 24 24" fill="none">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Analyze Data
                    </button>
                </form>
                
                <a href="{% url 'ask_chat' selected_type selected_source.id %}" class="btn-action btn-chat">
                    <svg class="icon" viewBox="0 0 24 24" fill="none">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Open Chat
                </a>
            </div>
            
            {% if source_info.error %}
            <div class="error-box">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="16" x2="12.01" y2="16" stroke="currentColor" stroke-width="2"/>
                </svg>
                <span>{{ source_info.error }}</span>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Available Sources Grid -->
    <div class="sources-grid">
        <!-- Uploaded Files Section -->
        {% if uploaded_files %}
        <div class="sources-section">
            <h2 class="section-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" stroke="currentColor" stroke-width="2"/>
                    <polyline points="13 2 13 9 20 9" stroke="currentColor" stroke-width="2"/>
                </svg>
                Uploaded Files ({{ uploaded_files.count }})
            </h2>
            
            <div class="sources-list">
                {% for file in uploaded_files %}
                <div class="source-card {% if selected_source and selected_type == 'file' and selected_source.id == file.id %}selected{% endif %}">
                    <div class="card-header">
                        <h3 class="card-title">{{ file.name }}</h3>
                        <span class="card-type">
                            {% if file.name|lower|slice:"-4:" == '.csv' %}CSV{% else %}Excel{% endif %}
                        </span>
                    </div>
                    <div class="card-body">
                        <p class="card-date">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            {{ file.uploaded_at|date:"M d, Y H:i" }}
                        </p>
                    </div>
                    <div class="card-actions">
                        <form method="GET" action="{% url 'data_sources' %}" style="display: inline;">
                            <input type="hidden" name="source_id" value="{{ file.id }}">
                            <input type="hidden" name="source_type" value="file">
                            <button type="submit" class="btn-card">Select</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Database Connections Section -->
        {% if db_connections %}
        <div class="sources-section">
            <h2 class="section-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                    <ellipse cx="12" cy="5" rx="9" ry="3" stroke="currentColor" stroke-width="2"/>
                    <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" stroke="currentColor" stroke-width="2"/>
                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" stroke="currentColor" stroke-width="2"/>
                </svg>
                Database Connections ({{ db_connections.count }})
            </h2>
            
            <div class="sources-list">
                {% for db in db_connections %}
                <div class="source-card {% if db.is_active %}active{% endif %} {% if selected_source and selected_type == 'db' and selected_source.id == db.id %}selected{% endif %}">
                    <div class="card-header">
                        <h3 class="card-title">
                            {{ db.name }}
                            {% if db.is_active %}
                            <span class="active-star">‚≠ê</span>
                            {% endif %}
                        </h3>
                        <span class="card-type">{{ db.get_engine_display }}</span>
                    </div>
                    <div class="card-body">
                        <p class="card-detail">
                            {% if db.engine == 'sqlite' %}
                                {{ db.sqlite_path|truncatechars:40 }}
                            {% else %}
                                {{ db.host }}:{{ db.port }}/{{ db.db_name }}
                            {% endif %}
                        </p>
                        <p class="card-date">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            {{ db.created_at|date:"M d, Y H:i" }}
                        </p>
                    </div>
                    <div class="card-actions">
                        <form method="GET" action="{% url 'data_sources' %}" style="display: inline;">
                            <input type="hidden" name="source_id" value="{{ db.id }}">
                            <input type="hidden" name="source_type" value="db">
                            <button type="submit" class="btn-card">Select</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Empty State -->
        {% if not uploaded_files and not db_connections %}
        <div class="empty-state">
            <svg class="empty-icon" viewBox="0 0 24 24" fill="none">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" stroke="currentColor" stroke-width="2"/>
            </svg>
            <h3>No data sources yet</h3>
            <p>Upload a file or connect to a database to get started</p>
            <div class="empty-actions">
                <a href="{% url 'upload_file' %}" class="btn-primary">Upload File</a>
                <a href="{% url 'connect_db' %}" class="btn-secondary">Connect Database</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Simple function to update hidden input based on selected option
function updateSourceType(select) {
    const selectedOption = select.options[select.selectedIndex];
    const sourceType = selectedOption.getAttribute('data-type');
    document.getElementById('source-type-input').value = sourceType || '';
}
</script>
{% endblock %}